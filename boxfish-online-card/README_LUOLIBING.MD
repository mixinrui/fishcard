## 一 鱼卡部分（boxfish-fishcard）
### 1 订单转换为服务
> RabbitMqReciver.orderConsumer(OrderForm)  
1  表结构：订单结构可查看OrderForm类，有几个需要注意的字段，OrderChannel(订单类型,标准付费订单为STANDARD)，ComboType(套餐类型)，tutorType(中外教)，productType(商品大类，1001对应上课，1002对应外教点评), classSize(小班课规模)。具体细节可以找订单组的细问。  
  
> 2 流程：订单模块通过mq发送消息到达鱼卡中心， 鱼卡中心会根据订单对应的组成部分进行拆分，最终组装称为service。中间需要注意的几个问题， mq消费失败会通过邮件的方式发送，邮件发送地址配置参数parameter.recipients。失败，可以通过重新发送消息或者调用接口的方式修复。

### 2 获取学生可选时间列表
> 1 接口：/service/student/v1/time/available（获取学生可选时间接口）  
> 2 参数表：
> 
|参数名称|参数作用|参数值含义|是否必需
|---|---|---|
|comboType|套餐类型|详情ComboTypeToRoleId类|是
|tutorType|上课类型|详情TutorType类|是
|productType|产品类型|详情ProductType类|是
|isFree|是否免费|历史遗留字段，并不影响|否
|order|订单ID|订单传递|是
|selectMode|选课方式|0:模板，1:自定义方式详情见SelectMode类|否(默认为0)
|delayWeek|推迟周数|int周|否
|totalWeeks|几周完成|int周|否
|classType|班型|详情见ClassTypeEnum类|否，小班课的时候起作用

> 3 返回值：一周的时间片  
> 4 工作流程：首先根据参数计算出一周的起始日期，计算方法为如果非延迟选时间，开始日期默认为同种类型（tutorType）的最后一个鱼卡的第二天（如果最后一个鱼卡在当前日期之前则为当前日期的第二天）；延迟选时间为延迟日期的时间。结束时间为开始日期+7天。添加过滤规则，现有的规则有：1、过滤掉已经有课的时间片 2、每个时间片都有出现的概率，通过概率计算出该时间片是否应该过滤。

### 3 学生选时间提交
> 1 接口：/service/student/v1/workorders  
> 2 参数表：
>
|参数名称|参数作用|参数值含义|是否必需
|---|---|---|
|skuId|skuId|中外教1：中教，2：外教|是
|orderId|订单Id|orderId|是
|productType|产品类型|详情ProductType类|是
|tutorType|上课类型|详情TutorType类|是
|comboType|套餐类型|详情ComboTypeToRoleId类|是
|selectMode|选课方式|0:模板，1:自定义方式详情见SelectMode类|否(默认为0)
|selectedTimes|所选时间片列表|时间片列表|是

> 3 返回值：成功或失败。  
> 失败返回{returnCode: 400, returnMsg: "失败信息"}    
> 4 工作流程：  
> 1 根据订单id查询是否有对应的服务，如果无对应的服务报（无对应服务，请重试）。   
> 2 根据选课模式selectMode，进行提交前验证。验证包括：
> 
* 重复提交验证，避免客户端重复提交。如果当前有该用户正在提交时间片，则提示“正在提交当中,请稍候...”。
* 权限验证，用户a只能选属于a用户的订单时间。否则会提示“非法用户，拒绝访问”
* 提交课程次数限制，每周次数限制，例如下订单的时候选择一周四节课，如果提交的时候发现有五节会提示“选择的上课次数不符合规范”， 若提交课程的次数，超过了所能选的课程次数，提示”选择的上课次数超过了可选次数“。
* 对于已经选过课的service，不能重复选课，否则提示"该订单已经完成选课,请勿重复选课"
* 提交时间重复性验证，若一个时间片已经有课了，这个时候重复选择该时间片，则提示“选择有重复的时间2017-01-01 10:00:00”。
* 每天上课数量限制，指定每天最多可以上4节课，超过这个限制会报“2017-01-01选课数量超过了最大4节课”；  

> 3 验证通过之后，根据选择模式，批量生成对应的鱼卡.  
> 4 提交前后验证。  
> 
* 每天上课数量校验，如果超过最大选课数量，则提示“2017-01-01选课数量超过了最大4节课”;
* 选课次数验证，再次验证上课次数与可选次数，不匹配则提示"选择的上课次数超过了可选次数"
* 对于模板提交方式，生成鱼卡之后还得验证一下是否同一时间片是否选择了该时间片。 如果已经选择则提示“选择有重复的时间2017-01-01 10:00:00”。

> 5 课程推荐。  
> 6 批量保存鱼卡，课程推荐等。

### 4 学生课表
> 1 接口：/service/student/{student_Id}/schedule/page?page=0&size=100  
> 2 参数表：请求头Accept-Language: en-US（zh-CN）实现国际化  
> 3 返回值：课表列表  
> 4 工作流程：学生课表使用了分流，首先使用一个缓存查看学生是否是购买用户，如果否，则返回默认的空学生课表；如果是，则查询数据库返回学生课表。

### 5 老师月历课表
> 1 接口：/service/teacher/{teacher_id}/schedule/month?count=3&yearMonth=201701  
> 2 参数表：请求头Accept-Language: en-US（zh-CN）实现国际化  
> 
|参数名称|参数作用|参数值含义|是否必需
|---|---|---|
|yearMonth|年月|201701|否（默认为当月）
|count|获取月总数|3|否（默认为6个月）

> 3 返回值：课表列表  
> 4 工作流程：  
> 
* 根据参数yearMonth和count计算出月历表的起始日期。
* 根据这个起始日期获取到老师所选时间片集合。
* 查询这个起始日期内该老师的所有课程（courseSchedule）。
* 使用课程表对老师时间片集合进行填充。
* 最后进行过滤，对于没有选课的时间片与已经过期的时间片进行过滤。

### 6 获取老师日历表
> 1 接口：/service/teacher/{teacher_id}/schedule/day?date=2017-01-01  
> 2 参数表：请求头Accept-Language: en-US（zh-CN）实现国际化  
> 3 返回值：当天的时间片集合
> 4 工作流程：
>
* 获取老师一天的时间范围，然后获取老师这天的时间片列表。
* 获取该老师这一天所选的课集合。
* 将课程信息填充到对应的时间片上。 

### 7 获取外教老师日历表
> 1 接口：/service/teacher/international/{teacher_id}/schedule/day?date=2017-01-01 10:00:00  
> 2 参数表：请求头Accept-Language: en-US（zh-CN）实现国际化  
> 3 返回值：本地时间对应北京时间的24小时课表(有可能本地时间对应北京时间两天)  
> 4 工作流程:  
> 
* App将当地时间对应的北京时间传递过来，然后根据北京起始时间计算出一个时间范围。
* 根据时间范围获取到对应的时间片集合。
* 根据起始时间获取对应的课程信息，然后将课程信息填充到时间片集合上。
* 过滤，摘头去尾，获取最终的结果。

### 8 课程推荐定时器
> 1 定时器：0 0 3 * * ?  
> 2 工作流程:
>
* 获取到72小时以内要上课的所有鱼卡列表以及课表列表，然后根据学生id进行分组。
* 以学生id分组，每组使用一个RecommendCourseTask进行处理。

### 9 学生进入公开课课堂
> 1 接口：/service/student/{studentId}/enter/publicClassRoom  
> 2 参数表：
> 
|参数名称|参数作用|参数值|是否必需
||||
|smallClassId|小班课id|smallClassId|是
|nickName|昵称|nickName|否  

> 3 工作流程：
>
* 先根据smallClassId获取对应的SmallClass公开课， 然后判断公开课是否为空，为空则提示“未安排的公开课~”  
* 然后判断当前是否在上课时间以内，如果不在这个范围内，则提示“同学, 你很积极呦, 但是上课时间还没到呢, 准点再来吧~”或者“啊，同学~ 你已经错过今天上课的时间啦，请明天准时再来吧！”。  
* 判断这个学生是否是第一次进入课堂， 如果不是，则直接返回让其进入课堂，并且将其加入实时课堂缓存。  
* 判断是否是学员，学员每天只能上一节课， 非学员不能进入课堂。  
* 进入课堂，更新实时课堂成员， 保存课堂成员数据，更新统计信息。

### 10 学生退出公开课课堂
> 1 接口：/service/student/{studentId}/quit/publicClassRoom  
> 2 参数列表：smallClassId：小班课id  
> 3 工作流程：将用户从实时课堂名单缓存中删除， 更改数据库记录。

### 11 公开课上课通知
> 1 定时器：0 25,55 9-23 * * ?  
> 2 工作流程：
> 
* 查询起始时间在当前时间后10分钟以内的开始公开课集合。
* 获取公开课对应的LEVEL，然后拼接成对应的tag值，然后调用boxfish-push推送服务发送到对应的tag中。



## 二 邮件提醒小程序（boxfish-online-card-mall）
### 1 发送邮件接口
> 1 接口：/send?token=xxxx  
> 2 参数表  
> 
|参数名称|参数作用|参数值|是否必需
||||
|recipients|收件人地址|邮件集合|是
|content|邮件内容|内容|是
|subject|邮件标题|标题|是
|from|发件人|发件人|是  
>
3 返回值{resultCode:200, resultMsg: "success"}  
4 工作流程: 首先需要对参数进行签名，签名使用","拼接的方式（secretKey,recipients,content,subject）然后对其进行md5计算出一个token，与传递过来的token进行比较，如果token不匹配，则提示签名失败。如果签名成功，则进行邮件发送。

### 2 课程推荐提醒邮件
> 1 定时器：0 0 5 * * *  
> 2 工作流程：查询48小时以内还没有推荐课程的集合，然后将其作为邮件内容发送给事先设置好的收件人。

## 三 修补程序(fixes)
### 1 同步课程信息与鱼卡
> 1 定时器：0 30 2 * * ?  
> 2 工作流程：Application.synchronousCourseInfo()。fixes程序主要是为了修复课程推荐问题，因为课程数据保存了三个地方，之前发现有极个别课程数据不一致的情况，导致看到的课和上的课程内容不一致；还有一个问题是课程经常会修改难度名称封面等内容，因为在线上课的课程信息不会及时同步，导致数据不一致。为了修复这些数据不一致的问题，会对三个地方的数据进行同步处理，最终上课的时候课程内容一致。

### 2 初始化基础时间片
> 1 接口：/baseTime/init/{days}  
> 2 工作流程：自动按照模板生成基础时间片最后一天往后推days天的所有时间片。

